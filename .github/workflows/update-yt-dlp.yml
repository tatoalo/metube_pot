name: update-yt-dlp

on:
  schedule:
    - cron: "0 0 */3 * *"
  workflow_dispatch:

jobs:
  update-yt-dlp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.TATOALO_REPO_PAT }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Check for yt-dlp nightly updates
        id: update
        run: |
          # Read current pinned version from Dockerfile
          CURRENT_VERSION=$(grep -oE "yt-dlp==[^ \"']*" Dockerfile | sed 's/yt-dlp==//')

          if [ -z "$CURRENT_VERSION" ]; then
            echo "::error::Could not extract yt-dlp version from Dockerfile"
            exit 1
          fi

          echo "Current version (Dockerfile): $CURRENT_VERSION"

          # Check latest available nightly (dry-run on clean env, nothing installed)
          pip install --dry-run --pre yt-dlp 2>&1 | tee /tmp/pip_output.txt

          LATEST_VERSION=$(grep "Would install" /tmp/pip_output.txt | grep -oE "yt-dlp-[^ ,]+" | sed 's/yt-dlp-//')

          if [ -z "$LATEST_VERSION" ]; then
            echo "::error::Could not determine latest yt-dlp nightly version"
            exit 1
          fi

          echo "Latest nightly version: $LATEST_VERSION"

          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
            echo "Update available: $CURRENT_VERSION -> $LATEST_VERSION"
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          else
            echo "yt-dlp is already up to date ($CURRENT_VERSION)"
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Dockerfile
        if: steps.update.outputs.has_update == 'true'
        env:
          LATEST_VERSION: ${{ steps.update.outputs.latest_version }}
        run: |
          echo "Updating Dockerfile with yt-dlp version $LATEST_VERSION"
          sed -i "s/yt-dlp==[^ \"']*/yt-dlp==$LATEST_VERSION/g" Dockerfile
          git diff Dockerfile

      - name: Create Pull Request
        if: steps.update.outputs.has_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.TATOALO_REPO_PAT }}
          CURRENT_VERSION: ${{ steps.update.outputs.current_version }}
          LATEST_VERSION: ${{ steps.update.outputs.latest_version }}
        run: |
          BRANCH="auto/update-yt-dlp-nightly-${LATEST_VERSION}"

          # Configure git
          git config user.email "updater@metube"
          git config user.name "AutoUpdater"

          # Reuse branch if it already exists (for retries), otherwise create it
          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            echo "Branch $BRANCH already exists, reusing it"
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git reset --hard "origin/$BRANCH"
          else
            git checkout -b "$BRANCH"
          fi

          # Commit only when there are changes
          git add Dockerfile
          if ! git diff --cached --quiet; then
            git commit -m "upgrade yt-dlp nightly to $LATEST_VERSION"
            git push -u origin "$BRANCH"
          else
            echo "No new Dockerfile changes to commit"
            git push -u origin "$BRANCH"
          fi

          # Reuse open PR if present, otherwise create one
          PR_URL=$(gh pr list \
            --repo "$GITHUB_REPOSITORY" \
            --state open \
            --head "$BRANCH" \
            --json url \
            --jq '.[0].url')

          if [ -z "$PR_URL" ]; then
            LABEL_ARGS=()
            if gh api "repos/$GITHUB_REPOSITORY/labels/automated" >/dev/null 2>&1; then
              LABEL_ARGS=(--label "automated")
            else
              echo "Label 'automated' not found; creating PR without label"
            fi

            PR_URL=$(gh pr create \
              --repo "$GITHUB_REPOSITORY" \
              --title "Upgrade yt-dlp nightly to $LATEST_VERSION" \
              --body "## Summary
          - Automated yt-dlp nightly update
          - Version: $CURRENT_VERSION -> $LATEST_VERSION

          ---
          *This PR was automatically created by the update-yt-dlp workflow.*" \
              "${LABEL_ARGS[@]}")
          fi

          gh pr merge "$PR_URL" --auto --squash

      - name: Summary
        if: always()
        env:
          HAS_UPDATE: ${{ steps.update.outputs.has_update }}
          CURRENT_VERSION: ${{ steps.update.outputs.current_version }}
          LATEST_VERSION: ${{ steps.update.outputs.latest_version }}
        run: |
          echo "## yt-dlp Nightly Update Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$HAS_UPDATE" = "true" ]; then
            echo "**Status**: Update available" >> $GITHUB_STEP_SUMMARY
            echo "**Current version**: $CURRENT_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "**Latest version**: $LATEST_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created or updated with auto-merge enabled." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status**: Already up to date" >> $GITHUB_STEP_SUMMARY
          fi
